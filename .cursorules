# Stock Analyzer - Project Rules for Cursor AI

## üìã Project Overview
Stock Analyzer - —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞–∫—Ü–∏–π –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–∏ (Moex) —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∏ —Ç–æ—Ä–≥–æ–≤—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.

## üéØ Core Principles
- **Accuracy**: –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- **Reliability**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- **Automation**: –ú–∏–Ω–∏–º—É–º —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –º–∞–∫—Å–∏–º—É–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- **Clarity**: –ü–æ–Ω—è—Ç–Ω—ã–µ –ª–æ–≥–∏, —è—Å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

## üêç Python Code Style
- **Version**: Python 3.8+
- **Style Guide**: PEP 8
- **Line Length**: 120 characters max
- **Type Hints**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **Docstrings**: –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Ñ–æ—Ä–º–∞—Ç:
  ```python
  def function_name(param: type) -> type:
      """
      –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.
      
      Args:
          param: –û–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
          
      Returns:
          –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
      """
  ```

## üìÅ Project Structure
```
stock_analyzer/
‚îú‚îÄ‚îÄ stock_data/                 # CSV —Ñ–∞–π–ª—ã —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ TICKER_full.csv        # –§–æ—Ä–º–∞—Ç: DATE,OPEN,HIGH,LOW,CLOSE,VOLUME
‚îú‚îÄ‚îÄ reports/                    # Markdown –æ—Ç—á—ë—Ç—ã (auto-generated)
‚îÇ   ‚îî‚îÄ‚îÄ report_YYYYMMDD_HHMMSS.md
‚îú‚îÄ‚îÄ recommendations/            # HTML —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (AI-generated)
‚îÇ   ‚îî‚îÄ‚îÄ RECOMMENDATIONS_YYYYMMDD.html
‚îú‚îÄ‚îÄ analysis_history/           # HTML –∞—É–¥–∏—Ç –æ—Ç—á—ë—Ç—ã (auto-generated)
‚îÇ   ‚îî‚îÄ‚îÄ AUDIT_REPORT_YYYYMMDD_HHMMSS.html
‚îú‚îÄ‚îÄ docs/                       # üìù –í–°–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø
‚îÇ   ‚îú‚îÄ‚îÄ README.md              # –ì–ª–∞–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md        # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ GUIDE_*.md             # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ (guide_cli, guide_analysis, etc)
‚îÇ   ‚îú‚îÄ‚îÄ TECHNICAL_*.md         # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ TUTORIAL_*.md          # –¢—É—Ç–æ—Ä–∏–∞–ª—ã
‚îÇ   ‚îî‚îÄ‚îÄ *.md                   # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ stock_data_manager.py       # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å Moex ISS API
‚îú‚îÄ‚îÄ technical_analysis.py       # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (ta-library)
‚îú‚îÄ‚îÄ report_generator.py         # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Markdown –æ—Ç—á—ë—Ç–æ–≤
‚îú‚îÄ‚îÄ audit_manager.py            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
‚îú‚îÄ‚îÄ audit_report_generator.py   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –∞—É–¥–∏—Ç –æ—Ç—á—ë—Ç–æ–≤
‚îú‚îÄ‚îÄ main.py                     # CLI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îú‚îÄ‚îÄ config.json                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–≤–æ—Ç—á–ª–∏—Å—Ç, –ø–∞–ø–∫–∏)
‚îú‚îÄ‚îÄ config_manager.py           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ config.json
‚îú‚îÄ‚îÄ promt.txt                   # –ü—Ä–æ–º—Ç –¥–ª—è AI (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π)
‚îú‚îÄ‚îÄ requirements.txt            # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .cursorules                 # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è Cursor AI
‚îú‚îÄ‚îÄ .cursor/config.json         # –ö–æ–Ω—Ñ–∏–≥ Cursor
‚îî‚îÄ‚îÄ .gitignore                  # Git –ø—Ä–∞–≤–∏–ª–∞
```

## üîß Key Technologies
- **API**: Moex ISS (https://iss.moex.com)
- **Data**: pandas, numpy
- **Technical Analysis**: ta-library (ta==0.11.0)
- **HTTP**: requests
- **Logging**: Python logging module

## üìä Data Format
### CSV Format (stock_data/*.csv)
```
DATE,OPEN,HIGH,LOW,CLOSE,VOLUME
2024-11-13,218.6,218.75,212.8,213.9,111806
2024-11-14,213.5,213.5,205.1,205.55,116583
```

### JSON Format (config.json)
```json
{
  "watchlist": ["SBER", "GAZP", "LKOH"],
  "data_folder": "stock_data",
  "reports_folder": "reports",
  "analysis_period_months": 6,
  "key_levels": {
    "SBER": {"support": [280, 290], "resistance": [310, 320]}
  }
}
```

## ü§ñ Technical Analysis Rules
1. **Always use ta-library** for indicators (ADX, RSI, EMA, MACD, BBANDS, OBV)
2. **False Recovery Detection**: –ò—Å–ø–æ–ª—å–∑—É–π `is_false_recovery()` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ª–æ–∂–Ω—ã—Ö –æ—Ç—Å–∫–æ–∫–æ–≤
3. **Trend Analysis**: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ADX > MA200 > MA50 > MA20
4. **Entry Points**: –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π (—Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞) + –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π (–æ—Ç–∫–∞—Ç)
5. **Risk Management**: Target 1:2 –º–∏–Ω–∏–º—É–º, —Å—Ç–æ–ø-–ª–æ—Å—Å –≤—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
6. **News Integration**: –ò—Å–ø–æ–ª—å–∑—É–π `web_search` –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º
   - –ù–æ–≤–æ—Å—Ç–∏ –º–æ–≥—É—Ç –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –∏–ª–∏ –û–ü–†–û–í–ï–†–ì–ù–£–¢–¨ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–∏–≥–Ω–∞–ª
   - –î–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª "üì∞ –ù–æ–≤–æ—Å—Ç–Ω–æ–π —Ñ–æ–Ω" –µ—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç–∏ –º–µ–Ω—è—é—Ç –∫–∞—Ä—Ç–∏–Ω—É
   - –ö—ç—à–∏—Ä—É–π –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ 24 —á–∞—Å–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìù Naming Conventions
### Python
- **Classes**: `PascalCase` (e.g., `StockDataManager`, `TechnicalAnalyzer`)
- **Functions**: `snake_case` (e.g., `download_stock_data`, `is_false_recovery`)
- **Constants**: `UPPER_SNAKE_CASE` (e.g., `MAX_LINE_LENGTH = 120`)
- **Private methods**: `_leading_underscore` (e.g., `_clean_data`)

### Files
- **Data**: `TICKER_full.csv` (e.g., `SBER_full.csv`) ‚Üí saved in `stock_data/`
- **Reports (auto)**: `report_YYYYMMDD_HHMMSS.md` ‚Üí saved in `reports/`
- **Recommendations (HTML)**: `RECOMMENDATIONS_YYYYMMDD.html` ‚Üí saved in `recommendations/`
- **Audit (HTML)**: `AUDIT_REPORT_YYYYMMDD_HHMMSS.html` ‚Üí saved in `analysis_history/`
- **Documentation (Markdown)**: `*.md` ‚Üí **SAVED IN `docs/` FOLDER**
  - Pattern: `docs/GUIDE_*.md`, `docs/TUTORIAL_*.md`, `docs/TECHNICAL_*.md`, etc.
  - Examples: `docs/GUIDE_CLI.md`, `docs/TUTORIAL_UPDATE_DATA.md`, `docs/TECHNICAL_INDICATORS.md`

## üé® HTML Recommendations Template

All recommendation HTML files MUST follow this template structure:

### HTML Structure
```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Meta tags, title, styles -->
</head>
<body>
    <div class="container">
        <header>
            <!-- Title, date, subtitle -->
        </header>
        
        <nav class="sticky">
            <!-- Navigation: –†–µ–π—Ç–∏–Ω–≥, –¢–û–ü-5, –ù–∞–±–ª—é–¥–µ–Ω–∏–µ, –ò–∑–±–µ–≥–∞—Ç—å, –ò—Ç–æ–≥–∏ -->
        </nav>
        
        <!-- SECTION 1: –†–µ–π—Ç–∏–Ω–≥ -->
        <section id="rating" class="rating-section">
            <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ BUY –°–∏–≥–Ω–∞–ª–æ–≤</h2>
            <!-- Stock cards with: Ticker, Price, Signal, Indicators, Levels, Analysis, Entry/Exit Table, Verdict -->
        </section>
        
        <!-- SECTION 2: –¢–û–ü-5 -->
        <section id="top5" class="top5-section">
            <h2>üéØ –¢–û–ü-5 –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –Ω–∞ –ù–µ–¥–µ–ª—é</h2>
            <!-- Numbered list with investment thesis -->
        </section>
        
        <!-- SECTION 3: –ù–∞–±–ª—é–¥–µ–Ω–∏–µ -->
        <section id="watch" class="watch-section">
            <h2>üëÅÔ∏è –ê–∫—Ü–∏–∏ –¥–ª—è –ù–∞–±–ª—é–¥–µ–Ω–∏—è</h2>
            <!-- HOLD stocks with conditions for entry -->
        </section>
        
        <!-- SECTION 4: –ò–∑–±–µ–≥–∞—Ç—å -->
        <section id="avoid" class="avoid-section">
            <h2>üö´ –ê–∫—Ü–∏–∏ –¥–ª—è –ò–∑–±–µ–≥–∞–Ω–∏—è</h2>
            <!-- Downtrend stocks to avoid -->
        </section>
        
        <!-- SECTION 5: –ò—Ç–æ–≥–∏ -->
        <section id="summary" class="summary-section">
            <h2>üìã –ò—Ç–æ–≥–æ–≤–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <!-- Market situation, strategy, risks, advice, final verdict -->
        </section>
        
        <footer>
            <!-- Date, disclaimer -->
        </footer>
    </div>
</body>
</html>
```

### Stock Card Structure (for each BUY recommendation)
```html
<div class="stock-card buy">
    <div class="stock-header">
        <div>
            <span class="ticker">TICKER_NAME</span>
            <p class="sector">Sector Description</p>
        </div>
        <div class="price-info">
            <span class="price">XXX.XX ‚ÇΩ</span>
            <span class="change positive/negative">¬±X.X%</span>
            <span class="signal buy">üü¢ BUY</span>
        </div>
    </div>
    
    <div class="indicators">
        <div class="indicator">
            <div class="indicator-label">–°–∫–æ—Ä</div>
            <div class="indicator-value">XX/100</div>
        </div>
        <!-- More indicators: –¢—Ä–µ–Ω–¥, RSI, –°–∏–≥–Ω–∞–ª -->
    </div>
    
    <div class="analysis-grid">
        <div class="analysis-box">
            <h4>üí° –û—Å–Ω–æ–≤–∞–Ω–∏–µ</h4>
            <p><!-- Analysis justification --></p>
        </div>
        <div class="analysis-box">
            <h4>üìà –£—Ä–æ–≤–Ω–∏</h4>
            <p>–ü–æ–¥–¥–µ—Ä–∂–∫–∞: X ‚ÇΩ<br>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: Y ‚ÇΩ</p>
        </div>
        <div class="analysis-box">
            <h4>‚ö†Ô∏è –†–∏—Å–∫–∏</h4>
            <p><!-- Risk description --></p>
        </div>
    </div>
    
    <table>
        <tr>
            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
            <th>–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π</th>
            <th>–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π</th>
        </tr>
        <tr>
            <td><strong>–í—Ö–æ–¥</strong></td>
            <td>XXX.XX (—Ç–µ–∫—É—â–∞—è)</td>
            <td>XXX.XX (–æ—Ç–∫–∞—Ç)</td>
        </tr>
        <tr>
            <td><strong>–¶–µ–ª—å 1</strong></td>
            <td>XXX.XX (+X%)</td>
            <td>XXX.XX (+X%)</td>
        </tr>
        <tr>
            <td><strong>–¶–µ–ª—å 2</strong></td>
            <td>XXX.XX (+X%)</td>
            <td>XXX.XX (+X%)</td>
        </tr>
        <tr>
            <td><strong>–°—Ç–æ–ø-–ª–æ—Å—Å</strong></td>
            <td>XXX.XX (-X%)</td>
            <td>XXX.XX (-X%)</td>
        </tr>
    </table>
    
    <div class="verdict positive/neutral/negative">
        <!-- Final recommendation with emoji -->
    </div>
</div>
```

### CSS Guidelines
- **Colors**: Gradient backgrounds for sections
  - Rating: `#667eea` to `#764ba2` (purple)
  - Top5: `#f093fb` to `#f5576c` (pink)
  - Watch: `#4facfe` to `#00f2fe` (cyan)
  - Avoid: `#fa709a` to `#fee140` (orange)
  - Summary: `#30cfd0` to `#330867` (teal)
- **Cards**: White background with left border (4px) color-coded by signal
- **Typography**: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
- **Responsive**: Grid layout with `auto-fit, minmax(250px, 1fr)`
- **Navigation**: Sticky top bar with smooth scroll

### JavaScript
- Smooth scroll to sections on nav click
- Must be functional without requiring external libraries

## üìã Workflow

### 1. Update Data
```bash
python main.py update
```
- Downloads new data from Moex ISS API
- Cleans duplicates and zero-volume entries
- Saves to `stock_data/*.csv`

### 2. Analyze
```bash
python main.py analyze
```
- Reads CSV files
- Calculates technical indicators (ta-library)
- Filters false recoveries
- Generates `reports/report_*.md`
- Saves BUY recommendations to `recommendations_archive.json`

### 3. Generate Recommendations (AI)
- Read latest `reports/report_*.md` and `stock_data/*.csv`
- Follow `.cursorules` HTML template
- Generate `recommendations/RECOMMENDATIONS_YYYYMMDD.html`

### 4. Audit
```bash
python main.py audit
```
- Checks past recommendations against new data
- Generates `analysis_history/AUDIT_REPORT_*.html`

## üö® False Recovery Detection
Must use `is_false_recovery()` function with 5 independent checks:
1. **ADX Double**: ADX-50 < 15 AND ADX-14 > 25 ‚Üí false recovery
2. **MACD Divergence**: Price ‚Üë BUT MACD ‚Üì ‚Üí false signal
3. **OBV**: Price ‚Üë BUT OBV ‚Üì ‚Üí volume not confirmed
4. **RSI Overbought**: RSI > 80 AND ADX-50 < 20 ‚Üí dangerous reversal
5. **Bollinger Bands**: Price at upper band AND no trend ‚Üí local max

Exclude stock if >= 2 conditions met.

## üîç Code Review Checklist
- [ ] Type hints on all functions
- [ ] Docstrings on all functions (Russian)
- [ ] Error handling with try-except
- [ ] Logging at appropriate levels (info, warning, error)
- [ ] CSV files properly formatted
- [ ] JSON valid and properly indented
- [ ] HTML valid and responsive
- [ ] No hardcoded paths (use config)
- [ ] All recommendations have BUY signal (score >= 60)
- [ ] No false recovery stocks in recommendations

## üìù Important Notes
- **Always log**: Use logger.info(), logger.warning(), logger.error()
- **No hardcoding**: Use config.json for all settings
- **Error handling**: Never let exceptions propagate uncaught
- **Data validation**: Always validate CSV format before processing
- **API limits**: Moex ISS API has rate limits, use appropriate delays
- **Timezone**: Use datetime.now() without timezone assumptions
- **Recommendations**: Only BUY signals (score >= 60) go to archive
- **Exclusions**: False recovery stocks are excluded from recommendations

## üéì Learning Resources
- Moex ISS API: https://iss.moex.com
- ta-library docs: https://github.com/bukosabino/ta
- PEP 8: https://www.python.org/dev/peps/pep-0008/
- Technical Analysis: RSI, EMA, ADX concepts

## üìû Support
For questions about the project structure or coding standards, refer to:
- `docs/ARCHITECTURE.md` - Project architecture
- `docs/README.md` - Main documentation (in docs/ folder!)
- `promt.txt` - AI instructions for recommendations

---

## üéØ CRITICAL RULE FOR AI ASSISTANT

### üìù All Documentation MUST be saved in `docs/` folder

When generating any Markdown documentation (guides, tutorials, explanations, etc.):
1. **ALWAYS** save to `docs/` subfolder
2. **Format**: `docs/GUIDE_*.md`, `docs/TUTORIAL_*.md`, `docs/TECHNICAL_*.md`
3. **Never** create MD files in the root directory
4. **Examples of correct paths**:
   - ‚úÖ `docs/GUIDE_CLI.md`
   - ‚úÖ `docs/TUTORIAL_ANALYSIS.md`
   - ‚úÖ `docs/TECHNICAL_INDICATORS.md`
   - ‚ùå `GUIDE_CLI.md` (wrong - in root!)
   - ‚ùå `README.md` (wrong - use `docs/README.md`)

### üìã File Organization Summary
- **CSV data** ‚Üí `stock_data/`
- **Auto reports** ‚Üí `reports/`
- **HTML recommendations** ‚Üí `recommendations/`
- **HTML audit** ‚Üí `analysis_history/`
- **ALL Markdown docs** ‚Üí `docs/` ‚Üê **KEY RULE**

